<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="My notes from #djangocon ü¶Ä day 2."><meta name=keywords content><link rel=canonical href=http://www.djpeacher.com/posts/djangocon-us-22-day-2/><link rel=stylesheet href=https://cdn.simplecss.org/simple.min.css><link rel=stylesheet href=/css/simple-plus.css><link rel=stylesheet href=/css/custom.css><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><title>DjangoCon US 2022: Day 2 | Jonathan Peacher</title><style>:root{--bg:#fff;--accent-bg:#f5f5f5;--text:#212121;--text-light:#585858;--border:#d8dae1;--accent:#212121;--code:#d81b60;--preformatted:#444;--marked:#ffdd33;--disabled:#efefef}@media(prefers-color-scheme:dark){:root{--bg:#212121;--accent-bg:#2b2b2b;--text:#dcdcdc;--text-light:#ababab;--border:#666;--accent:#809fff;--code:#f06292;--preformatted:#ccc;--marked:#ffdd33;--disabled:#111}}</style><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/SebastianAigner/twemoji-amazing@1.0.0/twemoji-amazing.css><link rel=alternate type=application/rss+xml href=/posts/index.xml title="Jonathan Peacher"><link rel=me href=https://fosstodon.org/@djpeacher><script src=https://cdn.usefathom.com/script.js data-site=KFUFSJGY defer></script></head><body><header><nav><a href=/>Home</a>
<a href=/about/>About</a>
<a href=/now/>Now</a></nav><h1>DjangoCon US 2022: Day 2</h1><p>My notes from #djangocon ü¶Ä day 2.</p><time datetime=221018>221018</time></header><main><h2 id=keeping-track-of-architectural-ish-decisions-in-a-sustainable-wayhttps2022djangoconustalkskeeping-track-of-architectural-ish-in-a><a href=https://2022.djangocon.us/talks/keeping-track-of-architectural-ish-in-a/>Keeping track of architectural-ish decisions in a sustainable way</a></h2><ul><li>The Problem<ul><li><strong>Is there a problem?</strong> Image a new coworker asks why a particular decision was made, but no one knows. We lose relevant information of the decision making process (e.g. context and alternatives considered).</li><li><strong>Why is this a problem?</strong> We cannot reliably reflect on our decisions, onboard new people, or evolve.</li><li><strong>What&rsquo;s causing this?</strong> Perhaps our tools are not specifically designed to capture changes, nor why they changed.</li></ul></li><li>Architectural Decisions: The thing we need to capture.<ul><li><strong>Architectural Decisions (AD)</strong>: A software design choice&mldr;that is architecturally significant. It&rsquo;s an AD if you need to ask:<ul><li>Should we meet to discuss this?</li><li>What framework should we use?</li><li>Could we use [shiny-new-thing] for this?</li></ul></li><li><strong>Architecturally Significant Requirement (ASR)</strong>: A requirement that has a measurable effect.</li></ul></li><li><a href=https://cognitect.com/blog/2011/11/15/documenting-architecture-decisions>Architectural Decision Record</a> (ADR) [<a href=https://18f.gsa.gov/2021/07/06/architecture_decision_records_helpful_now_invaluable_later/>also</a>]: The tool we can use to capture.<ul><li><strong>What is an ADR?</strong> A short, practical to fill, text file describing a specific AD. Like a journal entry to future developers.</li><li><strong>Who is it for?</strong> Primarily for developers and technology staff.</li><li><strong>What&rsquo;s in it?</strong>:<ul><li>Context: Why did this need to happen? What need to be considered?</li><li>Options: What were the options? What were the pros/cons of each?</li><li>Consequences: What will happen as a result?</li><li>Status: Has the decision been implemented or superseded?</li></ul></li><li><strong>Where does it live?</strong> Close to code (benefits from peer reviewing and discoverability), wiki, or something else.</li></ul></li><li>Takeaways:<ul><li>Leads teams to consensus.</li><li>Prevents knowledge hoarding.</li><li>Gets new maintainers up to speed.</li><li>Not one person with critical knowledge.</li><li>Shows maintainers if a change they&rsquo;d like to do has been considered previously.</li><li>Can be used as justification to stakeholders.</li></ul></li></ul><h2 id=django-migrations-pitfalls-and-solutionshttps2022djangoconustalksdjango-migrations-pitfalls-and-solutions><a href=https://2022.djangocon.us/talks/django-migrations-pitfalls-and-solutions/>Django Migrations: Pitfalls and Solutions</a></h2><ul><li>Migrations and Branches<ul><li>Rewinding migrations only works if the relevant migration files are in the codebase, regardless of applied migrations.</li><li>This can cause problems when switching branches with divergent migrations. Solutions:<ul><li>Reverse migrations before switching branches.</li><li>Restore a backup from before you ran either branch&rsquo;s migrations.</li><li>Use backward compatible migrations.</li></ul></li><li>A similar problem occurs when trying to merge two branches with divergent migrations. Solution:<ul><li><code>python manage.py makemigration -merge</code></li></ul></li></ul></li><li>Reversible Migrations<ul><li>Migrations are not time travel&mldr;database backups are!</li><li>Common rewind errors include, using <code>RunPython</code> with no reverse function, removing a constraint if data has been added that violates that constraint, or deleting a field that is non-null and has no default.</li><li>You can improve reversibility by backing up your database, set fields as nullable for some time before deleting them, and using a reverse function with <code>RunPython</code> (or at least use <code>noop</code>).</li></ul></li><li>Backwards Compatible Migrations<ul><li>The Deployment Race Condition: When, during deployment, the codebase and database will be out of sync! This can cause errors on your site if a request comes in while they are out of sync.</li><li>Assuming you are adding to the database more often than removing, you can reduce the frequency of this issue by migrating the database first, then deploying your new code.</li><li>For all other cases, you should try to create backwards compatible migration, i.e. migrations that once applied still work with you old code before that it gets updated.</li><li>Some migrations trivially backwards compatible:<ul><li>Ops with no DB schema change (RunPython, changing choices, squashing migrations, etc.)</li><li>Adding a nullable field.</li><li>Adding a model.</li><li>Removing/Relaxing a constraint.</li><li>Adding a constraint that all existing data/code already meets.</li><li>Removing a model that isn&rsquo;t referenced.</li></ul></li><li>Others, are not. For those, we want to try and get those to &ldquo;look&rdquo; like the above list.<ul><li>You can make some migration noops by using legacy database names.<ul><li>To rename a field, set <code>db_column</code> to the old name, and django will not update the database.</li><li>To rename a model, set <code>db_table</code> to old name, and django will not update the database.</li><li>You can even move models between apps an avoid schema changes by using <code>db_table</code> and <code>SperateDatabaseAndState</code>.</li></ul></li><li>You can decompose some migrations into two deploys.<ul><li>Adding a constraint: First deploy code that satisfies constraint, then deploy migration to update data.</li><li>Removing a model: First deploy code that remove all references, then deploy migration to remove the model.</li><li>Remove a field: First deploy code that deprecates the field using <code>django-deprecate-fields</code> and remove all code references, then deploy migration to remove the field.</li></ul></li><li>For all other, more complicated, cases, use scheduled downtime (maintenance mode).<ul><li>Split/Merge fields/models.</li><li>Change field types.</li><li>Do &ldquo;true&rdquo; field/model renames.</li><li>Compress multiple releases into one.</li></ul></li></ul></li></ul></li><li>Failed Migrations<ul><li>If your migrations fail, be aware that:<ul><li>You should abort your deployment.</li><li>Each migration is atomic, but the group of them are not.</li><li>If your migrations are not backwards compatible, your users will be getting errors (unless you are in maintenance mode).</li><li>If your migrations are not backwards compatible, your database will be in an incompatible state, and you can&rsquo;t use <code>manage.py shell</code>.</li></ul></li><li>To fix this:<ul><li>Avoid this to begin with by testing against production data!</li><li>Correct data with <code>manage.py shell</code>, assuming your migrations were backwards compatible.</li><li>Push the broken migration onto the server (because you should have aborted the deployment), and reverse them (assuming they were reversible).</li><li>Restore database to a backup.</li><li><code>manage.py dbshell</code></li></ul></li></ul></li></ul><h2 id=django-through-the-yearshttps2022djangoconustalksdjango-through-the-years><a href=https://2022.djangocon.us/talks/django-through-the-years/>Django Through the Years</a></h2><p>Not much to say about this, other than it was a very fun history lesson! ‚ù§Ô∏è</p><h2 id=just-enough-ops-for-developershttps2022djangoconustalksjust-enough-ops-for-developers><a href=https://2022.djangocon.us/talks/just-enough-ops-for-developers/>Just enough ops for developers</a></h2><p>My main takeaway here was the following <a href=https://fastapi.tiangolo.com/async/>fastapi analogy</a>:</p><ul><li>CPU = Cook</li><li>Process = Cashier</li><li>Request = Customer</li></ul><h2 id=your-first-deployment-shouldnt-be-so-hardhttps2022djangoconustalksyour-first-deployment-shouldn-t-be-so><a href=https://2022.djangocon.us/talks/your-first-deployment-shouldn-t-be-so/>Your First Deployment Shouldn&rsquo;t Be So Hard!</a></h2><p>Django is great, until you get to deployment, at which point there are a billion different ways to do it. This can be a barrier to entry for new developers and for experienced developers who need to prototype rapidly&mldr;enter <code>django-simple-deploy</code>.</p><p>Prerequisites:</p><ul><li>A simple Django project.</li><li>Use requirements.txt, Poetry, or Pipenv.</li><li>Use Git.</li><li>Have the target platform&rsquo;s CLI installed with an active account.</li></ul><pre tabindex=0><code>$ pip install django-simple-deploy
# Add simple deploy to INSTALLED APPS.
$ manage.py simple_deploy --platform fly_io --automate-all
# Profit!
</code></pre><a class="button replyButton" href="mailto: reply@djpeacher.com?subject=Reply to 'DjangoCon%20US%202022%3a%20Day%202'">Reply via email</a></main><footer><p>CC 2022 Jonathan Peacher. <a href=http://creativecommons.org/licenses/by-sa/4.0/>Some rights reserved.</a></p></footer></body></html>